<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>Dashboard - POS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-light">

    <div class="container py-4">
        <h2 class="mb-4">üìä Dashboard - ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>

        <div class="row mb-4">
            <!-- ‡∏™‡∏£‡∏∏‡∏õ -->
            <div class="col-md-3">
                <div class="card text-bg-primary shadow">
                    <div class="card-body">
                        <h5 class="card-title">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h5>
                        <p class="card-text fs-4" id="salesToday">0 ‡∏ö‡∏≤‡∏ó</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-bg-success shadow">
                    <div class="card-body">
                        <h5 class="card-title">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h5>
                        <p class="card-text fs-4" id="totalEmployees">0 ‡∏Ñ‡∏ô</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-bg-warning shadow">
                    <div class="card-body">
                        <h5 class="card-title">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å</h5>
                        <p class="card-text fs-4" id="stockItems">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-bg-info shadow">
                    <div class="card-body">
                        <h5 class="card-title">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
                        <p class="card-text fs-4" id="totalCustomers">0 ‡∏Ñ‡∏ô</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‡∏Å‡∏£‡∏≤‡∏ü -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <h5 class="card-title">‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h5>
                <canvas id="salesChart" height="100"></canvas>
            </div>
        </div>
    </div>
    <script src="env.js"></script>
    <script>
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
        async function fetchData() {
            try {
                const BASE_URL = ENV.api;

                const [salesRes, empRes, stockRes, cusRes] = await Promise.all([
                    fetch(BASE_URL + "sales"),
                    fetch(BASE_URL + "employees"),
                    fetch(BASE_URL + "stock"),
                    fetch(BASE_URL + "customers")
                ]);

                const salesData = await salesRes.json();
                const empData = await empRes.json();
                const stockData = await stockRes.json();
                const cusData = await cusRes.json();
                const stockList = stockData.stocks || [];
                const today = new Date().toISOString().split("T")[0];
                const salesToday = salesData.filter(s => s.created_at?.startsWith(today));
                const totalToday = salesToday.reduce((sum, sale) => sum + sale.total_price, 0);
                document.getElementById("salesToday").innerText = totalToday.toLocaleString() + " ‡∏ö‡∏≤‡∏ó";

                document.getElementById("totalEmployees").innerText = empData.length + " ‡∏Ñ‡∏ô";
                document.getElementById("stockItems").innerText = stockList.length + " ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";

                document.getElementById("totalCustomers").innerText = cusData.length + " ‡∏Ñ‡∏ô";

                const salesByDate = {};
                salesData.forEach(sale => {
                    const date = sale.created_at?.split("T")[0];
                    if (!salesByDate[date]) salesByDate[date] = 0;
                    salesByDate[date] += sale.total_price;
                });

                const labels = Object.keys(salesByDate).slice(-7);
                const values = labels.map(date => salesByDate[date]);

                new Chart(document.getElementById("salesChart"), {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                            data: values,
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.2
                        }]
                    }
                });

            } catch (err) {
                console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
            }
        }

        fetchData();
    </script>

</body>

</html>